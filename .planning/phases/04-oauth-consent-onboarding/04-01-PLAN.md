---
phase: 04-oauth-consent-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - workflows/fortnox-consent-onboarding.json
  - package.json
autonomous: true
requirements:
  - AUTH-05
  - AUTH-06
  - AUTH-07

must_haves:
  truths:
    - "Agency can share a single /webhook/fortnox-consent/start URL that redirects clients to the Fortnox OAuth consent screen with account_type=service"
    - "After client completes Fortnox consent, the TenantId is extracted from the JWT access token and stored in an n8n Data Table"
    - "Agency receives a Slack notification with company name and TenantId when a client completes consent"
    - "Client sees a styled HTML success page with their company name after authorization"
    - "Client sees a styled HTML error page if anything goes wrong during the flow"
    - "CSRF protection via state parameter prevents unauthorized callback submissions"
    - "Workflow is self-documented with sticky notes containing setup instructions"
  artifacts:
    - path: "workflows/fortnox-consent-onboarding.json"
      provides: "Complete n8n workflow template for OAuth consent onboarding"
      contains: "fortnox-consent"
    - path: "package.json"
      provides: "Updated files array including workflows directory"
      contains: "workflows"
  key_links:
    - from: "Webhook /start node"
      to: "Fortnox OAuth consent screen"
      via: "302 redirect with authorization URL containing client_id, scope, state, account_type=service"
      pattern: "apps.fortnox.se/oauth-v1/auth"
    - from: "Webhook /callback node"
      to: "Fortnox token endpoint"
      via: "HTTP Request POST with authorization_code grant and Basic auth"
      pattern: "apps.fortnox.se/oauth-v1/token"
    - from: "JWT decode Code node"
      to: "Data Table upsert"
      via: "Extracted tenantId from JWT payload stored as row"
      pattern: "Buffer.from.*base64"
    - from: "Data Table insert"
      to: "Slack notification"
      via: "Company name and TenantId forwarded to Slack message"
      pattern: "Slack"
---

<objective>
Create the complete Fortnox OAuth consent onboarding workflow as a portable n8n workflow template (JSON file) and bundle it in the npm package.

Purpose: Enable agencies to onboard clients through a self-service Fortnox authorization link. Clients click a URL, authorize on Fortnox, and the agency captures the TenantId needed to create n8n credentials -- without the client ever touching n8n.

Output: `workflows/fortnox-consent-onboarding.json` (complete, importable n8n workflow) and updated `package.json`
</objective>

<execution_context>
@/Users/adamnoren/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamnoren/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-oauth-consent-onboarding/04-RESEARCH.md
@credentials/FortnoxApi.credentials.ts

<interfaces>
<!-- No TypeScript interfaces needed -- this phase produces a JSON workflow file, not compiled code. -->
<!-- The workflow references the FortnoxApi credential type by name ('fortnoxApi') for ClientId/ClientSecret. -->
<!-- All nodes used are built-in n8n core nodes -- no custom node code required. -->

From credentials/FortnoxApi.credentials.ts:
- Credential name: 'fortnoxApi'
- Fields: clientId, clientSecret, tenantId, scopes, accessToken (hidden/expirable)
- Token endpoint: https://apps.fortnox.se/oauth-v1/token
- Auth: Basic (clientId:clientSecret)
- The workflow's purpose is to capture tenantId values that feed into this credential type

Fortnox OAuth endpoints (from 04-RESEARCH.md):
- Authorization: GET https://apps.fortnox.se/oauth-v1/auth
  Params: client_id, redirect_uri, response_type=code, scope, state, account_type=service
- Token exchange: POST https://apps.fortnox.se/oauth-v1/token
  Body: grant_type=authorization_code, code, redirect_uri
  Auth: Basic (client_id:client_secret)
- Company info: GET https://api.fortnox.se/3/companyinformation
  Auth: Bearer {access_token}
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create the complete OAuth consent onboarding workflow JSON</name>
  <files>workflows/fortnox-consent-onboarding.json</files>
  <action>
Create `workflows/` directory and write `workflows/fortnox-consent-onboarding.json` -- a complete, importable n8n workflow template.

**Workflow structure -- two parallel branches sharing one workflow:**

**Branch A: /start (initiate consent)**
1. **Webhook node** ("Client Visits Start URL"):
   - httpMethod: GET
   - path: `fortnox-consent/start`
   - responseMode: `responseNode` (Using 'Respond to Webhook' Node)
   - Set webhookId to match the path for reliable routing

2. **Code node** ("Generate State and Auth URL"):
   - Generate CSRF state token: `crypto.randomBytes(32).toString('hex')`
   - Auto-detect redirect URI from request headers: `$json.headers['x-forwarded-proto'] || 'https'` + `$json.headers.host` + `/webhook/fortnox-consent/callback`
   - Hardcode all 18 Fortnox scopes (per AUTH-08 / research recommendation):
     `archive article assets bookkeeping companyinformation costcenter currency customer invoice offer order price print project salary settings supplier supplierinvoice`
   - Construct Fortnox authorization URL using URL class:
     - Base: `https://apps.fortnox.se/oauth-v1/auth`
     - Params: client_id (from workflow field/sticky note instructions), redirect_uri, response_type=code, scope (space-separated), state, account_type=service
   - **IMPORTANT:** Do NOT include `access_type=offline` (not needed per research -- consent only captures TenantId)
   - Return: `{ authorizationUrl, state, redirectUri, createdAt }`
   - The Code node needs to reference the ClientId. Since n8n workflow Code nodes cannot directly access credential fields, add a **workflow-level sticky note** instructing the user to set the ClientId in a dedicated "Settings" Code node or Edit Fields (Set) node at the top of the /start branch. Use a Set node named "App Settings" at the start of the /start branch with fields: `clientId` (string) and `clientSecret` (string) that the user fills in from their Fortnox Developer Portal. The Code node then reads `$('App Settings').first().json.clientId`.

3. **Data Table node** ("Save State Token"):
   - Operation: insert (or upsert by state value)
   - Table: "Consent States" (document in sticky note that user must create this table)
   - Fields: state (text), createdAt (text), redirectUri (text)

4. **Respond to Webhook node** ("Redirect to Fortnox"):
   - respondWith: redirect
   - redirectURL: `={{ $('Generate State and Auth URL').first().json.authorizationUrl }}`
   - responseCode: 302

**Branch B: /callback (process OAuth response)**
5. **Webhook node** ("Fortnox OAuth Callback"):
   - httpMethod: GET
   - path: `fortnox-consent/callback`
   - responseMode: `responseNode`
   - Set webhookId to match the path

6. **Code node** ("Validate State"):
   - Read `$json.query.state` and `$json.query.code` from the callback
   - Also read `$json.query.error` to detect if Fortnox returned an error (user denied consent)
   - If error parameter exists or code is missing, throw an Error to route to error page
   - Store code and state in output for next node
   - Also extract host/protocol from callback request for redirect_uri reconstruction

7. **Data Table node** ("Lookup State Token"):
   - Operation: search/getAll with filter matching the received state value
   - From table "Consent States"

8. **Code node** ("Verify State Token"):
   - Check if a matching state was found
   - Check TTL: state must be < 10 minutes old (compare createdAt to now)
   - If invalid or expired, throw Error
   - Pass through the authorization code and reconstructed redirectUri

9. **HTTP Request node** ("Exchange Code for Token"):
   - Method: POST
   - URL: `https://apps.fortnox.se/oauth-v1/token`
   - Authentication: None (we build the Basic auth header manually)
   - Headers:
     - Authorization: `Basic {base64(clientId:clientSecret)}` -- build this in a preceding Code node or use expression referencing the "App Settings" node: `={{ 'Basic ' + Buffer.from($('App Settings').first().json.clientId + ':' + $('App Settings').first().json.clientSecret).toString('base64') }}`
   - Body (form-urlencoded):
     - grant_type: authorization_code
     - code: from previous node
     - redirect_uri: reconstructed from state lookup or callback request
   - On error: continue (so we can show error page instead of crashing)

10. **Code node** ("Decode JWT and Extract TenantId"):
    - Decode JWT access token: `JSON.parse(Buffer.from($json.access_token.split('.')[1], 'base64').toString())`
    - Extract: tenantId (convert to String), scope
    - If access_token missing or JWT decode fails, throw Error
    - Return: `{ tenantId, accessToken, scope, expiresIn }`

11. **HTTP Request node** ("Verify Consent - Get Company Info"):
    - Method: GET
    - URL: `https://api.fortnox.se/3/companyinformation`
    - Headers: `Authorization: Bearer {accessToken from previous node}`
    - Purpose: Verify consent works AND retrieve company name for the success page and Data Table

12. **Code node** ("Prepare Consent Record"):
    - Extract: CompanyName from `$json.CompanyInformation.CompanyName`
    - Combine with tenantId, scopes granted, and current timestamp
    - Format for Data Table upsert and Slack message

13. **Data Table node** ("Store Consent in Table"):
    - Operation: upsert
    - Table: "Fortnox Consents" (document in sticky note that user must create this)
    - Match column: TenantId
    - Fields: TenantId (text), Company Name (text), Scopes Granted (text), Timestamp (text)
    - Upsert prevents duplicate rows if same client re-authorizes

14. **Slack node** ("Notify Agency"):
    - Operation: Send Message
    - Channel: configurable (user fills in)
    - Message text (Block Kit formatting):
      ```
      :white_check_mark: *New Fortnox Consent*
      *Company:* {{ companyName }}
      *TenantId:* {{ tenantId }}
      *Scopes:* {{ scopes }}
      *Time:* {{ timestamp }}
      ```
    - On error: continue (Slack failure should not break the flow for the client)

15. **Respond to Webhook node** ("Show Success Page"):
    - respondWith: text (which sends HTML with text/html content type)
    - responseCode: 200
    - Body: Static HTML success page with inline CSS:
      - Centered layout, system font stack, light gray background
      - Green checkmark icon (Unicode ✔ / `&#10004;`)
      - Heading: `{{ companyName }} has been authorized`
      - Subtext: "You can close this page."
      - NO JavaScript, NO external resources (iframe sandbox safe)

**Error handling branch:**
16. **Respond to Webhook node** ("Show Error Page"):
    - Connected from error outputs and If-node failure branches
    - respondWith: text
    - responseCode: 200 (not 4xx -- keep it friendly for non-technical clients)
    - Body: Static HTML error page with inline CSS:
      - Same layout as success page
      - Red X icon (Unicode ✘ / `&#10008;`)
      - Heading: "Something went wrong"
      - Subtext: "Please contact your agency for help."
      - NO technical details exposed

**Error routing:** Use If nodes or error handling connections to route failures from token exchange, JWT decode, and company info verification to the error page Respond to Webhook node.

**Sticky notes (5 total):**
1. "Setup Instructions" (large, positioned at top-left, color: yellow/4):
   - Title: `## Fortnox Consent Onboarding`
   - Steps:
     1. Create two Data Tables in n8n: "Consent States" (columns: state, createdAt, redirectUri) and "Fortnox Consents" (columns: TenantId, Company Name, Scopes Granted, Timestamp)
     2. Fill in ClientId and ClientSecret in the "App Settings" node from your Fortnox Developer Portal
     3. Register redirect URI in Fortnox Developer Portal: `https://<your-n8n-host>/webhook/fortnox-consent/callback`
     4. Connect your Slack credential to the "Notify Agency" node (optional)
     5. Activate this workflow
     6. Share this link with clients: `https://<your-n8n-host>/webhook/fortnox-consent/start`
   - How it works section explaining the flow

2. "Start Flow" note near the /start webhook branch

3. "Callback Flow" note near the /callback webhook branch

4. "TenantId Capture" note near the JWT decode and Data Table nodes:
   - Explains that TenantId is extracted from JWT access token
   - Agency copies TenantId from the "Fortnox Consents" table to create a new FortnoxApi credential

5. "Error Handling" note near the error page node

**Node positioning:** Layout nodes left-to-right with the /start branch on top and /callback branch below. Sticky notes positioned near their relevant node groups. Use reasonable x,y coordinates with ~250px horizontal spacing and ~150px vertical spacing.

**Workflow metadata:**
- name: "Fortnox Consent Onboarding"
- active: false (user activates after setup)
- Tags: empty array
- Settings: default n8n workflow settings

**Node connection format:** Follow n8n workflow JSON structure with `connections` object mapping node names to output arrays and connection targets.

**CRITICAL implementation notes:**
- All node `typeVersion` values must match current n8n versions (Webhook v2, Code v2, HTTP Request v4.2, Respond to Webhook v1.1, If v2, Set/Edit Fields v3.4, Data Table -- use latest available, Slack v2.3, Sticky Note v1)
- Each node needs unique `id` (use UUIDs or short hex strings)
- Webhook nodes need `webhookId` field set for production URL consistency
- The JSON must be valid and importable in n8n -- test by validating JSON structure
- Do NOT reference any custom credential type in the workflow -- the "App Settings" Set node holds ClientId/ClientSecret as plain text fields that the user fills in. This makes the workflow fully portable without requiring the n8n-nodes-fortnox package to be installed (though it complements it).
  </action>
  <verify>
    <automated>node -e "const w = require('./workflows/fortnox-consent-onboarding.json'); const names = w.nodes.map(n => n.name); console.log('Nodes:', names.length); console.log('Has start webhook:', names.some(n => n.includes('Start'))); console.log('Has callback webhook:', names.some(n => n.includes('Callback'))); console.log('Has state:', names.some(n => n.includes('State'))); console.log('Has JWT:', names.some(n => n.includes('JWT') || n.includes('Decode') || n.includes('TenantId'))); console.log('Has Slack:', names.some(n => n.includes('Slack') || n.includes('Notify'))); console.log('Has success page:', names.some(n => n.includes('Success'))); console.log('Has error page:', names.some(n => n.includes('Error'))); console.log('Has sticky notes:', w.nodes.filter(n => n.type === 'n8n-nodes-base.stickyNote').length >= 3); console.log('Valid JSON: true'); const conn = Object.keys(w.connections || {}); console.log('Connected nodes:', conn.length);"</automated>
  </verify>
  <done>
    - workflows/fortnox-consent-onboarding.json exists and is valid JSON
    - Contains two webhook trigger nodes with paths fortnox-consent/start and fortnox-consent/callback
    - Contains Code node that generates CSRF state token and constructs Fortnox authorization URL with account_type=service
    - Contains HTTP Request node for token exchange at apps.fortnox.se/oauth-v1/token
    - Contains Code node that decodes JWT to extract TenantId
    - Contains HTTP Request node that verifies consent via /3/companyinformation
    - Contains Data Table nodes for state storage and consent upsert (TenantId, Company Name, Scopes, Timestamp)
    - Contains Slack notification node
    - Contains Respond to Webhook nodes for styled HTML success and error pages
    - Contains at least 3 sticky notes including setup instructions
    - All nodes are connected via the connections object
  </done>
</task>

<task type="auto">
  <name>Task 2: Bundle workflow in npm package and verify</name>
  <files>package.json</files>
  <action>
Update `package.json` to include the workflows directory in the published npm package:

1. In the `"files"` array, add `"workflows"` alongside the existing `"dist"` entry:
   ```json
   "files": [
     "dist",
     "workflows"
   ]
   ```

2. Verify the workflow JSON is valid by running:
   - `node -e "JSON.parse(require('fs').readFileSync('workflows/fortnox-consent-onboarding.json', 'utf8'))"` (valid JSON check)
   - `npm run build` (ensure existing build still passes -- workflow JSON doesn't go through TypeScript build but package.json changes could affect it)

3. Verify the workflow would be included in npm publish:
   - `npm pack --dry-run` and confirm `workflows/fortnox-consent-onboarding.json` appears in the output

That's it. No TypeScript changes, no credential type changes, no node changes. The existing FortnoxApi credential type stays as-is. The workflow template is a standalone JSON file that agencies import into their n8n instance.
  </action>
  <verify>
    <automated>cd /Users/adamnoren/n8n-nodes-fortnox && node -e "const pkg = require('./package.json'); console.log('files includes workflows:', pkg.files.includes('workflows'));" && node -e "JSON.parse(require('fs').readFileSync('workflows/fortnox-consent-onboarding.json', 'utf8')); console.log('Valid JSON');" && npm run build 2>&1 | tail -3 && npm pack --dry-run 2>&1 | grep -c "workflows/"</automated>
  </verify>
  <done>
    - package.json "files" array includes "workflows"
    - workflows/fortnox-consent-onboarding.json is valid JSON
    - npm run build succeeds without errors
    - npm pack --dry-run shows workflows/fortnox-consent-onboarding.json in the package contents
  </done>
</task>

</tasks>

<verification>
Phase 4 complete when:
1. `workflows/fortnox-consent-onboarding.json` exists and is a valid, importable n8n workflow
2. The workflow contains the complete OAuth consent flow: /start webhook -> Fortnox auth redirect -> /callback webhook -> token exchange -> JWT decode -> TenantId storage -> Slack notification -> HTML response pages
3. CSRF state parameter protection is implemented with Data Table storage and TTL validation
4. Styled HTML success/error pages are embedded in the Respond to Webhook nodes
5. Setup instructions are documented in sticky notes within the workflow
6. `package.json` includes `"workflows"` in the files array
7. `npm run build` passes and `npm pack --dry-run` includes the workflow file
</verification>

<success_criteria>
- Agency can import the workflow JSON into any n8n instance
- After following sticky note setup instructions (create tables, fill in credentials, register redirect URI, activate), the /start URL redirects clients to Fortnox OAuth consent
- After client authorization, TenantId appears in the "Fortnox Consents" Data Table
- Agency receives Slack notification with company name and TenantId
- Client sees friendly success or error HTML page
- Workflow ships as part of the npm package
</success_criteria>

<output>
After completion, create `.planning/phases/04-oauth-consent-onboarding/04-01-SUMMARY.md`
</output>
