---
phase: 02-invoice-resource
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nodes/Fortnox/GenericFunctions.ts
  - nodes/Fortnox/InvoiceDescription.ts
autonomous: true
requirements: [INV-01, INV-02, INV-03, INV-04, INV-05, INV-06, INV-07, INV-08, OPS-01, OPS-02, OPS-03]

must_haves:
  truths:
    - "fortnoxApiRequest sends authenticated requests to Fortnox API with automatic rate-limit retry on HTTP 429"
    - "fortnoxApiRequestAllItems paginates through all pages using MetaInformation.@TotalPages"
    - "Fortnox error responses are translated from Swedish to English using error code mapping"
    - "Invoice resource defines 8 operations: create, get, getMany, update, bookkeep, cancel, credit, send"
    - "Invoice create operation has fixedCollection for InvoiceRows with ArticleNumber, AccountNumber, DeliveredQuantity, Description, Price fields"
    - "Invoice getMany operation has returnAll toggle, limit field, and filter/date range additional fields"
  artifacts:
    - path: "nodes/Fortnox/GenericFunctions.ts"
      provides: "API request helper with rate-limit retry, pagination helper, error translation"
      exports: ["fortnoxApiRequest", "fortnoxApiRequestAllItems"]
    - path: "nodes/Fortnox/InvoiceDescription.ts"
      provides: "Invoice resource and operation property definitions for all 8 operations"
      exports: ["invoiceOperations", "invoiceFields"]
  key_links:
    - from: "nodes/Fortnox/GenericFunctions.ts"
      to: "credentials/FortnoxApi.credentials.ts"
      via: "httpRequestWithAuthentication('fortnoxApi', options)"
      pattern: "httpRequestWithAuthentication.*fortnoxApi"
    - from: "nodes/Fortnox/GenericFunctions.ts"
      to: "n8n-workflow"
      via: "NodeApiError, sleep imports"
      pattern: "import.*NodeApiError.*sleep.*from.*n8n-workflow"
---

<objective>
Create the reusable API infrastructure (GenericFunctions.ts) and Invoice resource property definitions (InvoiceDescription.ts) that form the foundation for all Fortnox node operations.

Purpose: GenericFunctions.ts is the single most important file -- it handles authentication delegation, rate-limit retry, error translation from Swedish to English, and pagination. InvoiceDescription.ts declares all 8 Invoice operations and their UI fields. Both files are consumed by the node's execute() method (Plan 02) and reused by all Phase 3 resources.

Output: Two new TypeScript files in nodes/Fortnox/ that compile cleanly and export the helper functions and property definitions.
</objective>

<execution_context>
@/Users/adamnoren/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamnoren/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-invoice-resource/02-RESEARCH.md
@.planning/phases/01-project-scaffold-credential-system/01-01-SUMMARY.md
@.planning/phases/01-project-scaffold-credential-system/01-02-SUMMARY.md

<interfaces>
<!-- Key types and contracts from Phase 1 that this plan depends on. -->

From credentials/FortnoxApi.credentials.ts:
- Credential name: `fortnoxApi`
- Authentication: Bearer token via `IAuthenticateGeneric` with header `Authorization: Bearer {{$credentials.accessToken}}`
- preAuthentication handles token fetch automatically; helpers.httpRequestWithAuthentication uses this

From nodes/Fortnox/Fortnox.node.ts:
- Node name: `fortnox`
- credentials: `[{ name: 'fortnoxApi', required: true, testedBy: 'fortnoxApiTest' }]`
- properties: [] (currently empty -- Plan 02 will populate)
- execute(): currently returns input items passthrough

From n8n-workflow (available imports):
```typescript
import type {
    IExecuteFunctions,
    ILoadOptionsFunctions,
    IHookFunctions,
    IHttpRequestMethods,
    IHttpRequestOptions,
    IDataObject,
    INodeExecutionData,
    INodeProperties,
    JsonObject,
} from 'n8n-workflow';
import { NodeApiError, sleep } from 'n8n-workflow';
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GenericFunctions.ts with API request, pagination, and error helpers</name>
  <files>nodes/Fortnox/GenericFunctions.ts</files>
  <action>
Create `nodes/Fortnox/GenericFunctions.ts` with three exports:

**1. `fortnoxApiRequest` function:**
- Signature: `async function fortnoxApiRequest(this: IExecuteFunctions | ILoadOptionsFunctions | IHookFunctions, method: IHttpRequestMethods, endpoint: string, body: IDataObject = {}, qs: IDataObject = {}): Promise<any>`
- Build `IHttpRequestOptions` with `url: 'https://api.fortnox.se' + endpoint`, `method`, `qs`, `json: true`
- Only set `options.body = body` if body has keys (action endpoints like bookkeep/cancel/credit need empty bodies -- do NOT send `{}`)
- Call `this.helpers.httpRequestWithAuthentication.call(this, 'fortnoxApi', options)` -- this delegates auth to the credential's preAuthentication + IAuthenticateGeneric
- Wrap in retry loop: `for (let attempt = 0; attempt <= MAX_RETRIES; attempt++)` where MAX_RETRIES = 3
- On catch: if `error.httpCode === '429'` and attempt < MAX_RETRIES, call `await sleep(BASE_DELAY_MS * Math.pow(2, attempt))` where BASE_DELAY_MS = 1000, then continue
- On non-429 errors or final attempt: call `throw parseFortnoxError.call(this, error)`
- Use `import { NodeApiError, sleep } from 'n8n-workflow'` -- both are confirmed available (sleep verified in node_modules/n8n-workflow/dist/cjs/utils.d.ts)

**2. `parseFortnoxError` internal function:**
- Signature: `function parseFortnoxError(this: IExecuteFunctions | ILoadOptionsFunctions | IHookFunctions, error: any): NodeApiError`
- Try to extract Fortnox error envelope: check `error.cause?.response?.body?.ErrorInformation`, then `error.body?.ErrorInformation`, then `error.description` (multiple paths since exact error shape depends on n8n version -- MEDIUM confidence per research)
- If ErrorInformation found: look up `code` in `FORTNOX_ERROR_MAP` for English translation; fall back to original Swedish `message` prefixed with code number
- Return `new NodeApiError(this.getNode(), error as JsonObject, { message: englishMessage, description: \`Fortnox error ${code}: ${originalMessage}\`, httpCode: error.httpCode })`
- If no ErrorInformation found: return `new NodeApiError(this.getNode(), error as JsonObject)` (let n8n handle generic errors)

**3. `FORTNOX_ERROR_MAP` constant:**
- Record<number, string> mapping common Fortnox error codes to English. Include at minimum:
  - 2000106: 'Value must be alphanumeric'
  - 2000108: 'Value must be numeric'
  - 2000134: 'Value must be a boolean'
  - 2000310: 'Invalid credentials'
  - 2000359: 'Value contains invalid characters'
  - 2000588: 'Invalid parameter in the request'
  - 2001304: 'Account not found'
  - 2001399: 'Invalid field name'
  - 2001101: 'No active license for the requested scope'
  - 1000003: 'System error -- contact Fortnox support'

**4. `fortnoxApiRequestAllItems` function:**
- Signature: `async function fortnoxApiRequestAllItems(this: IExecuteFunctions | ILoadOptionsFunctions, method: IHttpRequestMethods, endpoint: string, resourceKey: string, body: IDataObject = {}, qs: IDataObject = {}): Promise<IDataObject[]>`
- Set `qs.limit = 500` (Fortnox max per page), `qs.page = 1`
- Loop: call `fortnoxApiRequest.call(this, method, endpoint, body, qs)`, push `response[resourceKey]` items into `returnData` array
- Read `response.MetaInformation?.['@TotalPages']` (default 1), increment `qs.page`, continue while `page <= totalPages`
- Return accumulated `returnData` array

**Constants at top of file:**
```typescript
const FORTNOX_API_BASE = 'https://api.fortnox.se';
const MAX_RETRIES = 3;
const BASE_DELAY_MS = 1000;
```

**TypeScript imports:**
```typescript
import type {
    IExecuteFunctions,
    ILoadOptionsFunctions,
    IHookFunctions,
    IHttpRequestMethods,
    IHttpRequestOptions,
    IDataObject,
    JsonObject,
} from 'n8n-workflow';
import { NodeApiError, sleep } from 'n8n-workflow';
```

Export both `fortnoxApiRequest` and `fortnoxApiRequestAllItems`. Keep `parseFortnoxError` and `FORTNOX_ERROR_MAP` as module-internal (not exported).
  </action>
  <verify>
    <automated>cd /Users/adamnoren/n8n-nodes-fortnox && npx tsc --noEmit --strict nodes/Fortnox/GenericFunctions.ts 2>&1 | head -20</automated>
  </verify>
  <done>GenericFunctions.ts exists, exports fortnoxApiRequest and fortnoxApiRequestAllItems, compiles with no TypeScript errors. Rate-limit retry uses sleep() with exponential backoff. Error translation maps 10+ Fortnox error codes to English.</done>
</task>

<task type="auto">
  <name>Task 2: Create InvoiceDescription.ts with all 8 operation definitions and field properties</name>
  <files>nodes/Fortnox/InvoiceDescription.ts</files>
  <action>
Create `nodes/Fortnox/InvoiceDescription.ts` exporting two arrays: `invoiceOperations` and `invoiceFields`.

**Import:**
```typescript
import type { INodeProperties } from 'n8n-workflow';
```

**`invoiceOperations: INodeProperties[]`** -- Single options property:
- displayName: 'Operation', name: 'operation', type: 'options', noDataExpression: true
- displayOptions: `{ show: { resource: ['invoice'] } }`
- 8 options (alphabetical by name per n8n convention):
  - `{ name: 'Bookkeep', value: 'bookkeep', action: 'Bookkeep an invoice', description: 'Finalize an invoice in accounting' }`
  - `{ name: 'Cancel', value: 'cancel', action: 'Cancel an invoice', description: 'Cancel an invoice' }`
  - `{ name: 'Create', value: 'create', action: 'Create an invoice', description: 'Create a new invoice' }`
  - `{ name: 'Credit', value: 'credit', action: 'Credit an invoice', description: 'Create a credit note for an invoice' }`
  - `{ name: 'Get', value: 'get', action: 'Get an invoice', description: 'Retrieve an invoice by document number' }`
  - `{ name: 'Get Many', value: 'getMany', action: 'Get many invoices', description: 'List invoices with optional filters' }`
  - `{ name: 'Send', value: 'send', action: 'Send an invoice', description: 'Send an invoice via email' }`
  - `{ name: 'Update', value: 'update', action: 'Update an invoice', description: 'Update a draft (unbooked) invoice' }`
- default: 'getMany'

**`invoiceFields: INodeProperties[]`** -- All field definitions:

**A. Document Number** (shared by get, update, bookkeep, cancel, credit, send):
- displayName: 'Document Number', name: 'documentNumber', type: 'string', required: true
- displayOptions: `{ show: { resource: ['invoice'], operation: ['get', 'update', 'bookkeep', 'cancel', 'credit', 'send'] } }`
- description: 'The invoice document number in Fortnox'

**B. Customer Number** (required for create):
- displayName: 'Customer Number', name: 'customerNumber', type: 'string', required: true
- displayOptions: `{ show: { resource: ['invoice'], operation: ['create'] } }`
- description: 'The customer number from Fortnox customer register'

**C. Invoice Rows** (fixedCollection for create):
- displayName: 'Invoice Rows', name: 'invoiceRows', type: 'fixedCollection'
- typeOptions: `{ multipleValues: true }`
- displayOptions: `{ show: { resource: ['invoice'], operation: ['create'] } }`
- default: {}
- description: 'Line items for the invoice. Each row requires either an ArticleNumber or an AccountNumber.'
- options array with one entry:
  - displayName: 'Row', name: 'row', values array:
    - ArticleNumber (string, default: '', description: 'Article number from Fortnox article register')
    - AccountNumber (number, default: 0, description: 'Account number. Required if no ArticleNumber is provided.')
    - DeliveredQuantity (number, default: 1, description: 'Quantity delivered or invoiced')
    - Description (string, default: '', description: 'Line item description')
    - Price (number, default: 0, description: 'Unit price excluding VAT')

**D. Return All toggle** (getMany):
- displayName: 'Return All', name: 'returnAll', type: 'boolean'
- displayOptions: `{ show: { resource: ['invoice'], operation: ['getMany'] } }`
- default: false, description: 'Whether to return all results or only up to a given limit'

**E. Limit** (getMany when returnAll=false):
- displayName: 'Limit', name: 'limit', type: 'number'
- displayOptions: `{ show: { resource: ['invoice'], operation: ['getMany'], returnAll: [false] } }`
- typeOptions: `{ minValue: 1, maxValue: 500 }`
- default: 50, description: 'Max number of results to return'

**F. Filters** (collection for getMany):
- displayName: 'Filters', name: 'filters', type: 'collection', placeholder: 'Add Filter'
- displayOptions: `{ show: { resource: ['invoice'], operation: ['getMany'] } }`
- default: {}
- options:
  - Filter (options): displayName 'Filter', name 'filter', type 'options', options:
    - `{ name: 'Cancelled', value: 'cancelled' }`
    - `{ name: 'Fully Paid', value: 'fullypaid' }`
    - `{ name: 'Unbooked', value: 'unbooked' }`
    - `{ name: 'Unpaid', value: 'unpaid' }`
    - `{ name: 'Unpaid Overdue', value: 'unpaidoverdue' }`
    - default: '', description: 'Filter invoices by status'
  - From Date (string): name 'fromdate', default: '', description: 'Return invoices from this date (YYYY-MM-DD)'
  - To Date (string): name 'todate', default: '', description: 'Return invoices up to this date (YYYY-MM-DD)'
  - Sort By (options): name 'sortby', options: CustomerName, CustomerNumber, DocumentNumber, OCR, Total. default: '', description: 'Sort results by field'
  - Sort Order (options): name 'sortorder', options: ascending, descending. default: '', description: 'Sort direction'

**G. Additional Fields** (collection for create):
- displayName: 'Additional Fields', name: 'additionalFields', type: 'collection', placeholder: 'Add Field'
- displayOptions: `{ show: { resource: ['invoice'], operation: ['create'] } }`
- default: {}
- options (include the most commonly used fields):
  - DueDate (string, default: '', description: 'Invoice due date (YYYY-MM-DD)')
  - InvoiceDate (string, default: '', description: 'Invoice date (YYYY-MM-DD)')
  - Currency (string, default: '', description: 'Currency code (e.g., SEK, EUR, USD)')
  - OurReference (string, default: '', description: 'Internal reference')
  - YourReference (string, default: '', description: 'Customer reference')
  - YourOrderNumber (string, default: '', description: 'Customer order number')
  - InvoiceType (options: INVOICE, CASH, CREDIT, default: '', description: 'Invoice type')
  - TermsOfPayment (string, default: '', description: 'Payment terms code from Fortnox')
  - Comments (string, default: '', description: 'Comments on the invoice')
  - Freight (number, default: 0, description: 'Freight amount')
  - Language (options: SV, EN, default: '', description: 'Invoice language')
  - VATIncluded (boolean, default: false, description: 'Whether prices include VAT')

**H. Update Fields** (collection for update):
- displayName: 'Update Fields', name: 'updateFields', type: 'collection', placeholder: 'Add Field'
- displayOptions: `{ show: { resource: ['invoice'], operation: ['update'] } }`
- default: {}
- description: 'Only unbooked (draft) invoices can be updated'
- options: Same as Additional Fields above PLUS:
  - CustomerNumber (string, description: 'Change the customer on the invoice')
  - InvoiceRows (fixedCollection with same row structure as the create operation's invoiceRows)

All displayName values must be sentence case. All description values must NOT end with a period (n8n lint rule).
  </action>
  <verify>
    <automated>cd /Users/adamnoren/n8n-nodes-fortnox && npx tsc --noEmit --strict nodes/Fortnox/InvoiceDescription.ts 2>&1 | head -20</automated>
  </verify>
  <done>InvoiceDescription.ts exists, exports invoiceOperations (1 property with 8 operation options) and invoiceFields (all field definitions for all operations), compiles with no TypeScript errors. Operations are alphabetically ordered. fixedCollection for InvoiceRows has ArticleNumber, AccountNumber, DeliveredQuantity, Description, Price fields. getMany has returnAll toggle, limit, and filters collection.</done>
</task>

</tasks>

<verification>
1. Both files compile: `cd /Users/adamnoren/n8n-nodes-fortnox && npx tsc --noEmit`
2. GenericFunctions.ts exports fortnoxApiRequest and fortnoxApiRequestAllItems
3. InvoiceDescription.ts exports invoiceOperations and invoiceFields
4. No lint errors on new files: `npm run lint 2>&1 | tail -20`
</verification>

<success_criteria>
- GenericFunctions.ts compiles and exports fortnoxApiRequest (with 429 retry + error translation) and fortnoxApiRequestAllItems (page-based pagination)
- InvoiceDescription.ts compiles and exports invoiceOperations (8 operations) and invoiceFields (all field definitions)
- Error map covers 10+ common Fortnox error codes with English translations
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-invoice-resource/02-01-SUMMARY.md`
</output>
