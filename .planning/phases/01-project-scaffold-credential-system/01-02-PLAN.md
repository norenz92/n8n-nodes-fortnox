---
phase: 01-project-scaffold-credential-system
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - nodes/Fortnox/Fortnox.node.ts
  - nodes/Fortnox/Fortnox.node.json
  - nodes/Fortnox/fortnox.svg
autonomous: true
requirements:
  - COMP-01
  - OPS-04
  - OPS-05

must_haves:
  truths:
    - "Fortnox node appears in n8n with correct display name, icon, and category"
    - "Credential test button shows company name on success: 'Connected to Acme AB'"
    - "Credential test warns about missing scopes: 'Connected to Acme AB. Warning: missing scopes: invoice, article'"
    - "Credential test shows clear error message on authentication failure"
    - "Package builds cleanly with n8n-node build producing dist/ output"
    - "Package lints without errors"
  artifacts:
    - path: "nodes/Fortnox/Fortnox.node.ts"
      provides: "Minimal Fortnox node with credential test method"
      exports: ["Fortnox"]
      min_lines: 60
    - path: "nodes/Fortnox/Fortnox.node.json"
      provides: "Codex metadata for n8n node discovery"
      contains: "Finance & Accounting"
    - path: "nodes/Fortnox/fortnox.svg"
      provides: "Fortnox logo icon for n8n UI"
    - path: "dist/"
      provides: "Compiled JavaScript output"
  key_links:
    - from: "nodes/Fortnox/Fortnox.node.ts"
      to: "credentials/FortnoxApi.credentials.ts"
      via: "credentials[].name = 'fortnoxApi' with testedBy = 'fortnoxApiTest'"
      pattern: "fortnoxApi.*testedBy.*fortnoxApiTest"
    - from: "nodes/Fortnox/Fortnox.node.ts"
      to: "https://api.fortnox.se/3/companyinformation"
      via: "credentialTest method fetches company info"
      pattern: "companyinformation"
    - from: "nodes/Fortnox/Fortnox.node.ts"
      to: "nodes/Fortnox/fortnox.svg"
      via: "icon: 'file:fortnox.svg' in node description"
      pattern: "file:fortnox.svg"
    - from: "package.json"
      to: "dist/nodes/Fortnox/Fortnox.node.js"
      via: "n8n.nodes array"
      pattern: "dist/nodes/Fortnox/Fortnox.node.js"
---

<objective>
Create the minimal Fortnox node with custom credential test feedback and verify the entire package builds and lints cleanly.

Purpose: Complete the Phase 1 deliverable -- a working n8n community node package where users can create a Fortnox credential, test it, and see their company name. The credential test also validates scope grants, surfacing warnings for any missing scopes.

Output: A buildable, lintable package with a Fortnox node that appears in n8n and provides rich credential test feedback.
</objective>

<execution_context>
@/Users/adamnoren/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamnoren/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-scaffold-credential-system/01-RESEARCH.md
@.planning/phases/01-project-scaffold-credential-system/01-01-SUMMARY.md

<interfaces>
<!-- From Plan 01 - credential type the node references -->
From credentials/FortnoxApi.credentials.ts:
- Class: FortnoxApi (name = 'fortnoxApi')
- Properties: accessToken (hidden/expirable), clientId, clientSecret, tenantId, scopes (multiOptions)
- preAuthentication: fetches token from apps.fortnox.se/oauth-v1/token, returns { accessToken }
- authenticate: injects Bearer token via headers
- test: calls GET /3/companyinformation (simple test, will be overridden by node-level testedBy)

Token response shape:
{
  "access_token": "xyz...",
  "scope": "companyinformation invoice customer article order",
  "expires_in": 3600,
  "token_type": "bearer"
}

Company information response shape:
{
  "CompanyInformation": {
    "CompanyName": "Fortnox",
    "DatabaseNumber": 654896,
    "OrganizationNumber": "556469-6291",
    ...
  }
}
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Fortnox node with credential test, codex metadata, and SVG icon</name>
  <files>
    nodes/Fortnox/Fortnox.node.ts
    nodes/Fortnox/Fortnox.node.json
    nodes/Fortnox/fortnox.svg
  </files>
  <action>
Create the directory `nodes/Fortnox/` and the three files below.

**nodes/Fortnox/Fortnox.node.ts** -- Minimal node with custom credential test:

```typescript
import type {
    ICredentialTestFunctions,
    ICredentialsDecrypted,
    INodeCredentialTestResult,
    INodeType,
    INodeTypeDescription,
} from 'n8n-workflow';
```

Node class `Fortnox` implementing `INodeType`:

**description** (INodeTypeDescription):
- `displayName`: `'Fortnox'` (per user decision)
- `name`: `'fortnox'`
- `icon`: `'file:fortnox.svg'` (relative to node file directory)
- `group`: `['transform']`
- `version`: `1`
- `subtitle`: `'={{$parameter["operation"] + ": " + $parameter["resource"]}}'`
- `description`: `'Interact with the Fortnox accounting API'`
- `defaults`: `{ name: 'Fortnox' }`
- `inputs`: use `NodeConnectionType.Main` from n8n-workflow (import it)
- `outputs`: use `NodeConnectionType.Main` from n8n-workflow
- `credentials`: `[{ name: 'fortnoxApi', required: true, testedBy: 'fortnoxApiTest' }]`
- `properties`: Empty array `[]` (resource/operation properties come in Phase 2)

**methods.credentialTest** -- The `fortnoxApiTest` function:

This function provides custom credential test feedback per user decisions:
1. Make a GET request to `https://api.fortnox.se/3/companyinformation` using the credential's access token
2. Extract `CompanyName` from `response.CompanyInformation.CompanyName`
3. Compare requested scopes (from `credential.data.scopes`) against granted scopes:
   - The token response's scope field is not directly available here, so make a second token request to check granted scopes, OR (simpler and recommended): store the granted scopes from the token response. Since preAuthentication doesn't expose the full response, use this approach instead:
   - Call the token endpoint directly within the credential test to get the `scope` field from the response
   - Parse `credential.data` to get clientId, clientSecret, tenantId, and scopes
   - Make a POST to `https://apps.fortnox.se/oauth-v1/token` with the same parameters as preAuthentication
   - Compare the `scope` field in the response (space-separated string) against the requested scopes array
   - Build a list of missing scopes (requested but not in granted)
4. Return result:
   - All scopes granted: `{ status: 'OK', message: 'Connected to {CompanyName}' }`
   - Some scopes missing: `{ status: 'OK', message: 'Connected to {CompanyName}. Warning: missing scopes: {comma-separated missing scopes}' }`
   - Auth failure: `{ status: 'Error', message: 'Authentication failed: {error details}' }`

**Implementation approach for credential test:**
```typescript
async fortnoxApiTest(
    this: ICredentialTestFunctions,
    credential: ICredentialsDecrypted,
): Promise<INodeCredentialTestResult> {
    const { clientId, clientSecret, tenantId, scopes } = credential.data!;
    const requestedScopes = scopes as string[];

    try {
        // Step 1: Fetch token to get granted scopes
        const basicAuth = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');
        const scopeString = (requestedScopes).join(' ');

        const tokenResponse = await this.helpers.httpRequest({
            method: 'POST',
            url: 'https://apps.fortnox.se/oauth-v1/token',
            headers: {
                'Authorization': `Basic ${basicAuth}`,
                'Content-Type': 'application/x-www-form-urlencoded',
                'TenantId': tenantId as string,
            },
            body: `grant_type=client_credentials&scope=${encodeURIComponent(scopeString)}`,
        });

        const grantedScopes = (tokenResponse.scope as string).split(' ');
        const missingScopes = requestedScopes.filter(s => !grantedScopes.includes(s));

        // Step 2: Call company information endpoint
        const companyResponse = await this.helpers.httpRequest({
            method: 'GET',
            url: 'https://api.fortnox.se/3/companyinformation',
            headers: {
                'Authorization': `Bearer ${tokenResponse.access_token}`,
            },
        });

        const companyName = companyResponse.CompanyInformation?.CompanyName ?? 'Unknown';

        // Step 3: Build result message
        let message = `Connected to ${companyName}`;
        if (missingScopes.length > 0) {
            message += `. Warning: missing scopes: ${missingScopes.join(', ')}`;
        }

        return { status: 'OK', message };
    } catch (error) {
        return {
            status: 'Error',
            message: `Authentication failed: ${(error as Error).message}`,
        };
    }
}
```

**execute method:** Minimal placeholder that returns input items unchanged (real operations come in Phase 2):
```typescript
async execute(this: IExecuteFunctions) {
    const items = this.getInputData();
    return [items];
}
```

Import `IExecuteFunctions` from `n8n-workflow` for the execute method.

**nodes/Fortnox/Fortnox.node.json** -- Codex metadata:
```json
{
    "node": "n8n-nodes-fortnox.fortnox",
    "nodeVersion": "1.0",
    "codexVersion": "1.0",
    "categories": ["Finance & Accounting"],
    "resources": {
        "primaryDocumentation": [
            {
                "url": "https://developer.fortnox.se/documentation/"
            }
        ]
    }
}
```

**nodes/Fortnox/fortnox.svg** -- Fortnox logo icon:
Create a simplified SVG icon representing the Fortnox brand. Use a clean, recognizable "F" lettermark in Fortnox's green color (#3BAA35) on a transparent background. Size: 60x60 viewBox. Keep the SVG minimal (no embedded fonts, no external references). Example structure:
```xml
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60" fill="none">
  <rect width="60" height="60" rx="8" fill="#3BAA35"/>
  <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-weight="bold" font-size="36" fill="white">F</text>
</svg>
```
Use `<path>` elements instead of `<text>` to avoid font dependency issues. Create the "F" as a geometric path.
  </action>
  <verify>
    <automated>cd /Users/adamnoren/n8n-nodes-fortnox && npx tsc --noEmit && test -f nodes/Fortnox/fortnox.svg && test -f nodes/Fortnox/Fortnox.node.json && node -e "const m = require('./nodes/Fortnox/Fortnox.node.json'); if (!m.categories.includes('Finance & Accounting')) process.exit(1); console.log('OK')"</automated>
  </verify>
  <done>Fortnox.node.ts compiles, exports Fortnox class with credentialTest method (fortnoxApiTest) that returns company name on success and warns about missing scopes; node.json has Finance and Accounting category; SVG icon exists and uses path elements</done>
</task>

<task type="auto">
  <name>Task 2: Build package and verify complete output</name>
  <files></files>
  <action>
Run the full build and lint pipeline to verify the package is ready for npm publish.

**Step 1: Build**
```bash
cd /Users/adamnoren/n8n-nodes-fortnox && npm run build
```
This runs `n8n-node build` which:
- Compiles TypeScript to `dist/`
- Copies assets (SVG, JSON) to `dist/`
- Generates node metadata

Verify that these files exist after build:
- `dist/credentials/FortnoxApi.credentials.js`
- `dist/nodes/Fortnox/Fortnox.node.js`
- `dist/nodes/Fortnox/Fortnox.node.json`
- `dist/nodes/Fortnox/fortnox.svg`

**Step 2: Lint**
```bash
npm run lint
```
Fix any lint errors. Common fixes:
- Unused imports: remove them
- Missing return types: add explicit return types
- Any type usage: replace with specific types

If lint fails, fix the issues in the source files and re-run until clean.

**Step 3: Verify package structure**
```bash
npm pack --dry-run
```
Confirm that the output lists only files from `dist/`, `package.json`, and `LICENSE.md`. No source `.ts` files should be included.

**Step 4: Verify n8n section paths resolve**
Confirm that every path listed in `package.json`'s `n8n.credentials` and `n8n.nodes` arrays exists as an actual file in the built output.
  </action>
  <verify>
    <automated>cd /Users/adamnoren/n8n-nodes-fortnox && npm run build 2>&1 && test -f dist/credentials/FortnoxApi.credentials.js && test -f dist/nodes/Fortnox/Fortnox.node.js && test -f dist/nodes/Fortnox/fortnox.svg && echo "BUILD OK" && npm run lint 2>&1 && echo "LINT OK"</automated>
  </verify>
  <done>Package builds to dist/ with all credential and node files present, lints cleanly, npm pack --dry-run shows only dist/ files, all n8n section paths resolve to real files</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. `npm run lint` succeeds without errors
3. `dist/credentials/FortnoxApi.credentials.js` exists
4. `dist/nodes/Fortnox/Fortnox.node.js` exists
5. `dist/nodes/Fortnox/fortnox.svg` exists in dist
6. `dist/nodes/Fortnox/Fortnox.node.json` exists in dist
7. Fortnox node description has `displayName: 'Fortnox'`, `icon: 'file:fortnox.svg'`
8. Credential test method `fortnoxApiTest` exists and references `fortnoxApi` credential
9. Node category is `Finance & Accounting` in codex metadata
</verification>

<success_criteria>
- Build pipeline works: `npm run build && npm run lint` both succeed with zero errors
- Credential test is rich: shows company name on success, warns about missing scopes, shows clear error on failure
- Package is publishable: `npm pack --dry-run` shows correct file list, n8n section paths all resolve
- Node identity is correct: display name "Fortnox", SVG icon, "Finance & Accounting" category
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-scaffold-credential-system/01-02-SUMMARY.md`
</output>
