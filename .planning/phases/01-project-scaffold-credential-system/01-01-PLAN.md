---
phase: 01-project-scaffold-credential-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - eslint.config.mjs
  - .prettierrc.js
  - .gitignore
  - LICENSE.md
  - credentials/FortnoxApi.credentials.ts
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - AUTH-08
  - OPS-04
  - OPS-05

must_haves:
  truths:
    - "npm install succeeds and produces a valid node_modules with n8n-workflow and @n8n/node-cli"
    - "TypeScript compiles without errors (tsc --noEmit passes)"
    - "Credential file exports a class implementing ICredentialType with clientId, clientSecret, tenantId, and scopes fields"
    - "preAuthentication method sends client_credentials grant to Fortnox token endpoint with correct headers and body encoding"
    - "Access token is stored in a hidden expirable field so n8n re-fetches it automatically before expiry"
    - "Scope selection is a multiOptions field on the main credential form with core scopes selected by default"
  artifacts:
    - path: "package.json"
      provides: "npm package manifest with n8n community node configuration"
      contains: "n8n-community-node-package"
    - path: "tsconfig.json"
      provides: "TypeScript configuration targeting ES2019 with commonjs modules"
      contains: "outDir"
    - path: "credentials/FortnoxApi.credentials.ts"
      provides: "Fortnox credential type with preAuthentication token flow"
      exports: ["FortnoxApi"]
      min_lines: 80
    - path: "eslint.config.mjs"
      provides: "ESLint configuration importing from @n8n/node-cli"
    - path: ".prettierrc.js"
      provides: "Prettier configuration"
    - path: ".gitignore"
      provides: "Git ignore rules for node_modules, dist, etc."
  key_links:
    - from: "package.json"
      to: "dist/credentials/FortnoxApi.credentials.js"
      via: "n8n.credentials array"
      pattern: "dist/credentials/FortnoxApi.credentials.js"
    - from: "credentials/FortnoxApi.credentials.ts"
      to: "https://apps.fortnox.se/oauth-v1/token"
      via: "preAuthentication httpRequest"
      pattern: "apps.fortnox.se/oauth-v1/token"
    - from: "credentials/FortnoxApi.credentials.ts"
      to: "Bearer token injection"
      via: "authenticate.properties.headers.Authorization"
      pattern: "Bearer.*\\$credentials.accessToken"
---

<objective>
Create the n8n community node package skeleton and implement the Fortnox credential type with client credentials grant authentication.

Purpose: Establish the npm package foundation and solve the highest-risk problem -- Fortnox's two-phase authentication using preAuthentication with expirable token caching. This is the foundation everything else builds on.

Output: A valid npm package with TypeScript compilation, linting, and a complete credential type that can obtain and cache Fortnox access tokens.
</objective>

<execution_context>
@/Users/adamnoren/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamnoren/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-scaffold-credential-system/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create npm package skeleton with n8n community node conventions</name>
  <files>
    package.json
    tsconfig.json
    eslint.config.mjs
    .prettierrc.js
    .gitignore
    LICENSE.md
  </files>
  <action>
Create the project scaffold following the official n8n-nodes-starter template conventions. Do NOT use `npm init` or any interactive commands -- create all files directly.

**package.json:** Create with these exact settings:
- `name`: `n8n-nodes-fortnox`
- `version`: `0.1.0`
- `description`: `n8n community node for Fortnox accounting API`
- `keywords`: `["n8n-community-node-package"]`
- `license`: `MIT`
- `files`: `["dist"]`
- `scripts`: Use `n8n-node` CLI commands: `build` (`n8n-node build`), `dev` (`n8n-node dev`), `lint` (`n8n-node lint`), `lint:fix` (`n8n-node lint --fix`), `release` (`n8n-node release`), `prepublishOnly` (`n8n-node prerelease`)
- `n8n` section: `n8nNodesApiVersion: 1`, `strict: true`, `credentials: ["dist/credentials/FortnoxApi.credentials.js"]`, `nodes: ["dist/nodes/Fortnox/Fortnox.node.js"]`
- `peerDependencies`: `{ "n8n-workflow": "*" }`
- `devDependencies`: `{ "@n8n/node-cli": "*", "eslint": "9.32.0", "prettier": "3.6.2", "release-it": "^19.0.4", "typescript": "5.9.2" }`

**tsconfig.json:** Use the exact configuration from the n8n-nodes-starter template:
- `strict: true`, `module: "commonjs"`, `moduleResolution: "node"`, `target: "es2019"`
- `lib: ["es2019", "es2020", "es2022.error"]`
- `outDir: "./dist/"`, `declaration: true`, `sourceMap: true`, `skipLibCheck: true`
- `include: ["credentials/**/*", "nodes/**/*", "nodes/**/*.json", "package.json"]`

**eslint.config.mjs:**
```javascript
import { config } from '@n8n/node-cli/eslint';
export default config;
```

**.prettierrc.js:** Configure with tabs and single quotes per n8n conventions:
```javascript
module.exports = {
    semi: true,
    singleQuote: true,
    useTabs: true,
    tabWidth: 2,
    trailingComma: 'all',
    endOfLine: 'lf',
};
```

**.gitignore:** Include `node_modules/`, `dist/`, `.tsbuildinfo`, `*.js.map`, `.DS_Store`

**LICENSE.md:** MIT license with current year.

After creating all files, run `npm install` to install dependencies. Verify `node_modules` exists and contains `n8n-workflow`.
  </action>
  <verify>
    <automated>cd /Users/adamnoren/n8n-nodes-fortnox && test -f package.json && test -f tsconfig.json && test -f eslint.config.mjs && test -d node_modules/n8n-workflow && node -e "const p = require('./package.json'); if (!p.keywords.includes('n8n-community-node-package')) process.exit(1); if (!p.n8n.credentials[0].includes('FortnoxApi')) process.exit(1); console.log('OK')"</automated>
  </verify>
  <done>All scaffold files exist, npm install succeeds, package.json has correct n8n community node configuration with credentials and nodes paths pointing to dist/</done>
</task>

<task type="auto">
  <name>Task 2: Implement FortnoxApi credential type with preAuthentication and scope selection</name>
  <files>
    credentials/FortnoxApi.credentials.ts
  </files>
  <action>
Create `credentials/FortnoxApi.credentials.ts` implementing `ICredentialType` with the preAuthentication pattern (proven in Metabase credentials).

**Class structure:**
```typescript
export class FortnoxApi implements ICredentialType {
    name = 'fortnoxApi';
    displayName = 'Fortnox API';
    documentationUrl = ''; // No external docs per user decision
```

**Properties array (EXACT field order per user decision):**

1. **Access Token** (hidden, expirable -- MUST be first so preAuthentication works):
   - `name: 'accessToken'`, `type: 'hidden'`, `typeOptions: { expirable: true }`, `default: ''`

2. **Client ID**:
   - `displayName: 'Client ID'`, `name: 'clientId'`, `type: 'string'`, `default: ''`, `required: true`
   - `description`: Help text explaining where to find the value: `'Found in Fortnox Developer Portal under your app settings'`

3. **Client Secret**:
   - `displayName: 'Client Secret'`, `name: 'clientSecret'`, `type: 'string'`, `typeOptions: { password: true }`, `default: ''`, `required: true`
   - `description`: `'Found in Fortnox Developer Portal under your app settings'`

4. **Tenant ID**:
   - `displayName: 'Tenant ID'`, `name: 'tenantId'`, `type: 'string'`, `default: ''`, `required: true`
   - `description`: `'The numeric tenant identifier for the Fortnox company. Also known as the DatabaseNumber in Fortnox company information.'`

5. **Scopes** (multiOptions, on main form per user decision):
   - `displayName: 'Scopes'`, `name: 'scopes'`, `type: 'multiOptions'`
   - `default: ['companyinformation', 'invoice', 'customer', 'article', 'order']` (core scopes selected by default per user decision)
   - Options (alphabetical, 18 total from research): archive, article, assets, bookkeeping, companyinformation, costcenter, currency, customer, invoice, offer, order, price, print, project, salary, settings, supplier, supplierinvoice
   - Each option: `{ name: 'Human Readable Name', value: 'apivalue' }`
   - `description`: `'Scopes to request when obtaining access tokens. Must match scopes granted during client consent in the Fortnox Developer Portal.'`

**preAuthentication method:**
```typescript
async preAuthentication(
    this: IHttpRequestHelper,
    credentials: ICredentialDataDecryptedObject,
) {
    const clientId = credentials.clientId as string;
    const clientSecret = credentials.clientSecret as string;
    const tenantId = credentials.tenantId as string;
    const scopes = credentials.scopes as string[];
    const basicAuth = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');
    const scopeString = scopes.join(' ');

    const response = await this.helpers.httpRequest({
        method: 'POST',
        url: 'https://apps.fortnox.se/oauth-v1/token',
        headers: {
            'Authorization': `Basic ${basicAuth}`,
            'Content-Type': 'application/x-www-form-urlencoded',
            'TenantId': tenantId,
        },
        body: `grant_type=client_credentials&scope=${encodeURIComponent(scopeString)}`,
    });

    return { accessToken: response.access_token };
}
```

**authenticate property** (injects Bearer token from cached field):
```typescript
authenticate: IAuthenticateGeneric = {
    type: 'generic',
    properties: {
        headers: {
            Authorization: '=Bearer {{$credentials.accessToken}}',
        },
    },
};
```

**test property** (simple test -- the node-level credentialTest in Plan 02 will provide custom messages):
```typescript
test: ICredentialTestRequest = {
    request: {
        baseURL: 'https://api.fortnox.se',
        url: '/3/companyinformation',
    },
};
```

**Import types needed:**
```typescript
import type {
    IAuthenticateGeneric,
    ICredentialDataDecryptedObject,
    ICredentialTestRequest,
    ICredentialType,
    IHttpRequestHelper,
    INodeProperties,
} from 'n8n-workflow';
```

**IMPORTANT:** Use `application/x-www-form-urlencoded` Content-Type with a string body (NOT an object). The body must use `encodeURIComponent` for the scope string since scopes are space-separated. Do NOT use `this.helpers.request()` -- only `this.helpers.httpRequest()` is available in credential context.
  </action>
  <verify>
    <automated>cd /Users/adamnoren/n8n-nodes-fortnox && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>FortnoxApi.credentials.ts compiles without errors, exports FortnoxApi class implementing ICredentialType, has all 5 properties in correct order (accessToken hidden+expirable, clientId, clientSecret with password mask, tenantId, scopes with multiOptions and 5 core defaults), preAuthentication sends client_credentials grant to Fortnox token endpoint, authenticate injects Bearer token, test calls companyinformation endpoint</done>
</task>

</tasks>

<verification>
1. `npm install` completes without errors
2. `npx tsc --noEmit` passes with no errors
3. `package.json` contains `n8n-community-node-package` keyword and correct `n8n` section paths
4. `credentials/FortnoxApi.credentials.ts` exports `FortnoxApi` class
5. Credential has `preAuthentication` method calling `apps.fortnox.se/oauth-v1/token`
6. Credential has `authenticate` property injecting Bearer token
7. Scope field defaults include: companyinformation, invoice, customer, article, order
</verification>

<success_criteria>
- Project installs and compiles: `npm install && npx tsc --noEmit` both succeed
- Credential class is well-formed: exports FortnoxApi, implements ICredentialType
- Token flow is correct: preAuthentication uses Basic auth + TenantId header + URL-encoded body
- Scope selection works: multiOptions with 18 options and 5 defaults
- Package manifest is npm-publishable: has keyword, files, and n8n section
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-scaffold-credential-system/01-01-SUMMARY.md`
</output>
